/**
 * Implement Gatsby's Node APIs in this file.
 *
 * See: https://www.gatsbyjs.org/docs/node-apis/
 */

const path = require(`path`);
const _ = require(`lodash`);
const kontentItemTypeIdentifier = `KontentItem`;

exports.onCreateNode = ({ node, actions: { createNodeField } }) => {
  // Only get items generated by Kentico Kontent
  if (
    _.has(node, `internal.type`) &&
    _.isString(node.internal.type) &&
    node.internal.type.startsWith(kontentItemTypeIdentifier)
  ) {
    let data = {};

    // Content pages
    if (node.internal.type.includes("Column")) {
      data.name = node.elements.page_name.value;
      data.url = node.elements.url.value;
      data.content = node.elements.main_body_copy.value;
      data.type = "content";
    }

    // Briefing pages
    if (node.internal.type.includes("Briefing")) {
      data.name = node.elements.briefing_name.value;
      data.url = node.elements.url.value;
      data.content = node.elements.main_body_copy.value;
      data.type = "briefing";
    }

    // Create custom fields for each item
    Object.keys(data).forEach(key => {
      createNodeField({
        node,
        name: key,
        value: data[key],
      });
    });
  }
};

exports.createPages = async ({ graphql, actions }) => {
  const { createPage } = actions;

  const query = await graphql(`
    {
      allKontentItem {
        edges {
          node {
            id
            ... on KontentItemOneColumnContent {
              fields {
                name
                url
                type
                content
              }
            }
            ... on KontentItemTwoColumnContent {
              fields {
                name
                url
                type
                content
              }
            }
            ... on KontentItemThreeColumnContent {
              fields {
                name
                url
                type
                content
              }
            }
            ... on KontentItemBriefings {
              fields {
                name
                url
                type
                content
              }
            }
          }
        }
      }
    }
  `);

  query.data.allKontentItem.edges.forEach(({ node }) => {
    if (node.fields && node.fields.url && node.id) {
      createPage({
        path: node.fields.url,
        component: path.resolve(`src/templates/content.js`),
        context: Object.assign({ id: node.id }, node.fields),
      });
    }
  });
};
